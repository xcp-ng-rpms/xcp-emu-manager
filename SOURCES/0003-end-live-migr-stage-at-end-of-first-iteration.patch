From c6d1c1a1facef0bc6b3a45a7642e3be95010dca3 Mon Sep 17 00:00:00 2001
From: John Else <john.else@gmail.com>
Date: Sun, 18 Nov 2018 01:09:13 +0000
Subject: [PATCH] End the live migration stage at the end of the first
 iteration

Closes xcp-ng/xcp#72.
---
 bin/emu_manager.ml | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/bin/emu_manager.ml b/bin/emu_manager.ml
index 1d5062d..ea6676e 100644
--- a/bin/emu_manager.ml
+++ b/bin/emu_manager.ml
@@ -30,16 +30,20 @@ let save sock control_in_chan control_out_chan hvm domid save_params =
     Xenguest.(send sock Migrate_live);
 
     (* read and relay progress events. *)
+    let finished = ref false in
     let progress = ref 0 in
     let total    = ref 0 in
-    while !progress < 100 do
+    while not !finished do
       match Xenguest.receive sock with
       | Xenguest.(Progress {sent; remaining; iteration}) -> begin
         if remaining > 0
         then total := !total + remaining;
 
         progress := 100 * sent / !total;
-        Control.(send control_out_chan (Progress !progress))
+        Control.(send control_out_chan (Progress !progress));
+
+        if iteration > 0 || !progress >= 100
+        then finished := true
       end
       | _ -> ()
     done;
